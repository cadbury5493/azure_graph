index=ssc_inspec_event_idx exec_mode=weekly_ssc_dm018
| spath output=outer_status path=status
| stats 
    latest(outer_status) as host_status 
    by host_name
| stats
    count as total_hosts_scanned
    count(eval(host_status="passed")) as total_hosts_passed
    count(eval(host_status="failed")) as total_hosts_failed

---
index=ssc_inspec_event_idx bunit=awscentral_qualys
| stats 
    count AS total_controls,
    count(eval(Status="Passed")) AS passed_controls,
    count(eval(Status="Skipped")) AS skipped_controls
    BY "Host IP" "DNS Hostname"

| eval passed_skipped_controls = passed_controls + skipped_controls

| eval host_compliance_pct = round(
    (passed_skipped_controls / total_controls) * 100,
    2
)

| eval is_compliant_95 = if(host_compliance_pct > 95, 1, 0)

| stats
    sum(is_compliant_95) AS passing_hosts
    count AS hosts_scanned

| eval overall_compliance_pct = round(
    (passing_hosts / hosts_scanned) * 100,
    2
)

| fields overall_compliance_pct
---
index=ssc_inspec_event_idx bunit=awscentral_qualys
| stats 
    count AS total_controls
    BY "Host IP" "DNS Hostname"

| eval host_key = 'Host IP' . "||" . 'DNS Hostname'

| stats
    dc(host_key) AS total_hosts_scanned


---
index=ssc_inspec_event_idx bunit=awscentral_qualys
| stats 
    count AS total_controls,
    count(eval(Status="Passed")) AS passed_controls,
    count(eval(Status="Failed")) AS failed_controls,
    count(eval(Status="Skipped")) AS skipped_controls
    BY "Host IP" Technology "DNS Hostname"

| eval passed_skipped_controls = passed_controls + skipped_controls

| eval compliance_pct = round(
    (passed_skipped_controls / total_controls) * 100,
    2
)

| eval is_compliant_95 = if(compliance_pct > 95, "true", "false")

| eval host_key = 'Host IP' . "||" . 'DNS Hostname'

| stats
    dc(host_key) AS hosts_scanned
    count(eval(is_compliant_95="true")) AS passing_hosts
    count(eval(is_compliant_95="false")) AS failing_hosts
    BY Technology

| eval compliance_pct = round(
    (passing_hosts / hosts_scanned) * 100,
    2
)

| rename Technology AS platform

| table
    platform
    hosts_scanned
    passing_hosts
    failing_hosts
    compliance_pct






----
index=ssc_inspec_event_idx bunit=awscentral_qualys
| stats 
    count AS total_controls,
    count(eval(Status="Passed")) AS passed_controls,
    count(eval(Status="Failed")) AS failed_controls,
    count(eval(Status="Skipped")) AS skipped_controls
    BY "Host IP" Technology "DNS Hostname"

| eval passed_skipped_controls = passed_controls + skipped_controls

| eval compliance_percentage = round(
    (passed_skipped_controls / total_controls) * 100,
    2
)

| eval compliance_percentage_considering_skipped_as_failed = round(
    (passed_controls / total_controls) * 100,
    2
)

| eval is_compliant_95 = if(compliance_percentage > 95, "true", "false")

| rename Technology AS platform "DNS Hostname" AS host_name

| table 
    "Host IP"
    host_name
    platform
    total_controls
    passed_skipped_controls
    failed_controls
    compliance_percentage
    passed_controls
    skipped_controls
    compliance_percentage_considering_skipped_as_failed
    is_compliant_95

---
index=ssc_inspec_event_idx exec_mode=weekly_ssc_dmn018
| spath output=outer_status path=status
| spath path=results{} output=results
| mvexpand results
| spath input=results
| stats 
    dc(host_name) as total_hosts_scanned
    count(eval(outer_status="passed")) as total_controls_passed
    count(eval(outer_status="failed")) as total_controls_failed


---
index=ssc_inspec_event_idx exec_mode=weekly_ssc_dm018
| spath path=results{} output=results
| mvexpand results
| spath input=results
| stats 
    dc(host_name) as total_hosts_scanned
    count(eval(status="passed")) as total_controls_passed
    count(eval(status="failed")) as total_controls_failed
    by platfprm
| rename platfprm as platform
| sort - total_hosts_scanned

---
index=ssc_inspec_event_idx exec_mode=weekly_ssc_dm018 | spath output=outer_status path=status | spath path=results{} output=results | mvexpand results | spath input=results | eval reason=if(status=="failed", code_desc, null()) | stats values(reason) as failed_reasons values(platfprm) as platform values(environment) as environment values(outer_status) as outer_status by host_name | eval failed_reasons=if(isnull(failed_reasons), "None", mvjoin(failed_reasons, " || ")) | table host_name platform environment outer_status failed_reasons
